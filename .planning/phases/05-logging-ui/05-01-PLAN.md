---
phase: 05-logging-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/PhoneMirror/Views/MainWindow.axaml
  - src/PhoneMirror/ViewModels/MainWindowViewModel.cs
autonomous: true
---

<objective>
Implement collapsible log panel with copy functionality and actionable error guidance.

Purpose: Give users visibility into device errors during mirroring sessions and provide guidance for common issues.
Output: Collapsible log panel in MainWindow that displays logcat errors, supports copying to clipboard, and maps common errors to actionable guidance.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-capture-features/04-03-SUMMARY.md

@src/PhoneMirror/Views/MainWindow.axaml
@src/PhoneMirror/ViewModels/MainWindowViewModel.cs
@src/PhoneMirror.Core/Services/ILogcatService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create collapsible log panel with real-time display</name>
  <files>src/PhoneMirror/Views/MainWindow.axaml, src/PhoneMirror/ViewModels/MainWindowViewModel.cs</files>
  <action>
Replace the log panel placeholder (Grid.Row="4" in left column) with a functional collapsible log panel:

**MainWindow.axaml changes:**

1. Replace the placeholder Border (Grid.Row="4") with collapsible log panel:
   ```xaml
   <Border Grid.Row="4" ... IsVisible="{Binding IsLogPanelExpanded}">
     <!-- Log content -->
   </Border>
   ```

2. Add expand/collapse toggle in header area (Grid.Row="3" or new row):
   - Small toggle button with chevron icon (E70D down / E70E up)
   - Text: "EVENT LOG" with entry count badge
   - Clicking toggles IsLogPanelExpanded

3. Log content structure:
   - ItemsControl bound to LogEntries collection
   - Each entry: timestamp (dim), level (colored), tag, message
   - ScrollViewer with auto-scroll to bottom
   - Monospace font (Consolas or Cascadia Mono)
   - Max height constraint (e.g., 150-200 pixels)

4. Entry styling:
   - Error level (E): red/orange foreground
   - Warning level (W): yellow foreground
   - Other levels: default foreground
   - Use TextFillColorSecondaryBrush for timestamp

**MainWindowViewModel.cs changes:**

1. Add observable properties:
   ```csharp
   [ObservableProperty]
   private bool _isLogPanelExpanded = false;  // Hidden by default

   [ObservableProperty]
   private ObservableCollection<LogcatEntry> _logEntries = new();
   ```

2. Add computed property for entry count:
   ```csharp
   public string LogEntryCountText => LogEntries.Count > 0
       ? $"({LogEntries.Count})"
       : "";
   ```

3. Add ToggleLogPanelCommand:
   ```csharp
   [RelayCommand]
   private void ToggleLogPanel() => IsLogPanelExpanded = !IsLogPanelExpanded;
   ```

4. Subscribe to logcat updates using DispatcherTimer:
   - Poll ILogcatService.GetAllSessionErrors() every 500ms when mirroring
   - Update LogEntries collection with new entries
   - Start timer in ShowFloatingToolbar(), stop in CloseFloatingToolbar()

5. Clear LogEntries when mirroring stops in OnMirroringStopped

**Key patterns to follow:**
- Use Dispatcher.UIThread.Post for collection updates from timer
- Use ObservableCollection for automatic UI binding
- Match existing FluentAvalonia theme colors
  </action>
  <verify>Build succeeds, log panel appears when expanded, shows logcat entries during mirroring</verify>
  <done>Collapsible log panel displays real-time logcat errors from ILogcatService</done>
</task>

<task type="auto">
  <name>Task 2: Add copy button and actionable error mapping</name>
  <files>src/PhoneMirror/Views/MainWindow.axaml, src/PhoneMirror/ViewModels/MainWindowViewModel.cs</files>
  <action>
Add copy functionality and error guidance to the log panel:

**MainWindow.axaml changes:**

1. Add copy button to log panel header (next to expand toggle):
   - Small icon button with copy icon (E8C8)
   - ToolTip: "Copy logs to clipboard"
   - Command="{Binding CopyLogsCommand}"
   - Only visible when panel is expanded

2. Add clear button (optional, near copy):
   - Small icon button with delete icon (E74D)
   - ToolTip: "Clear logs"
   - Command="{Binding ClearLogsCommand}"

**MainWindowViewModel.cs changes:**

1. Add CopyLogsCommand:
   ```csharp
   [RelayCommand]
   private async Task CopyLogsAsync()
   {
       if (LogEntries.Count == 0)
       {
           StatusText = "No logs to copy";
           return;
       }

       var text = FormatLogsForClipboard(LogEntries);
       var clipboard = GetClipboard();
       if (clipboard != null)
       {
           await clipboard.SetTextAsync(text);
           StatusText = $"Copied {LogEntries.Count} log entries to clipboard";
       }
   }
   ```

2. Add FormatLogsForClipboard helper:
   ```csharp
   private static string FormatLogsForClipboard(IEnumerable<LogcatEntry> entries)
   {
       var sb = new StringBuilder();
       foreach (var entry in entries)
       {
           sb.AppendLine($"{entry.Timestamp:HH:mm:ss.fff} [{entry.Level}] {entry.Tag}: {entry.Message}");
       }
       return sb.ToString();
   }
   ```

3. Add ClearLogsCommand:
   ```csharp
   [RelayCommand]
   private void ClearLogs()
   {
       LogEntries.Clear();
       _logcatService.ClearErrors();
       OnPropertyChanged(nameof(LogEntryCountText));
   }
   ```

4. Add actionable error mapping in StatusText:

   Create a method to map common errors to guidance:
   ```csharp
   private string GetActionableGuidance(LogcatEntry entry)
   {
       // Map common error patterns to user-friendly guidance
       if (entry.Message.Contains("INSTALL_FAILED"))
           return "Installation failed - check device storage or app signature";
       if (entry.Message.Contains("SecurityException"))
           return "Permission denied - grant required permissions in device settings";
       if (entry.Message.Contains("OutOfMemoryError"))
           return "Device low on memory - close background apps";
       if (entry.Tag.Contains("ActivityManager") && entry.Message.Contains("crashed"))
           return "App crashed - check logcat for stack trace";
       return null;  // No specific guidance
   }
   ```

5. When updating StatusText with errors, include guidance:
   - On first error entry, update StatusText to show the guidance if available
   - Pattern: "Error: {tag} - {guidance}" or just show raw error if no guidance

**Error level color mapping (for XAML or converter):**
- E (Error): Use SystemFillColorCriticalBrush or #FF4444
- W (Warning): Use SystemFillColorCautionBrush or #FFAA00
- I (Info): TextFillColorSecondaryBrush
- D (Debug): TextFillColorTertiaryBrush
  </action>
  <verify>Build succeeds, copy button copies formatted logs, clear button works, status shows actionable guidance for known errors</verify>
  <done>Log panel has copy/clear functionality and provides actionable error guidance</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors
- [ ] Log panel hidden by default (IsLogPanelExpanded = false)
- [ ] Click toggle button expands/collapses log panel
- [ ] Logcat errors appear in panel during active mirroring
- [ ] Copy button copies formatted log text to clipboard
- [ ] Clear button removes all log entries
- [ ] Error entries show appropriate color (red for E, yellow for W)
- [ ] StatusText shows actionable guidance for known error patterns
</verification>

<success_criteria>
- Collapsible log panel in MainWindow (hidden by default)
- Real-time logcat error display from ILogcatService
- Copy to clipboard functionality with formatted output
- Clear logs functionality
- Actionable error guidance for common patterns
- LOGS-02, LOGS-03, LOGS-04 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-logging-ui/05-01-SUMMARY.md`
</output>
