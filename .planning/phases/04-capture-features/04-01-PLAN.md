---
phase: 04-capture-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/PhoneMirror.Core/Services/IScreenshotService.cs
  - src/PhoneMirror.Core/Services/ScreenshotService.cs
  - src/PhoneMirror/App.axaml.cs
  - src/PhoneMirror/ViewModels/MainWindowViewModel.cs
  - src/PhoneMirror/Views/MainWindow.axaml
autonomous: true
---

<objective>
Implement ADB screenshot-to-clipboard functionality.

Purpose: Allow users to quickly capture their device screen and paste it into other apps without leaving Phone Mirror.
Output: IScreenshotService that captures device screen via ADB screencap, writes to clipboard via Avalonia clipboard API.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mirror-ui/03-04-SUMMARY.md

@src/PhoneMirror.Core/Services/IAdbService.cs
@src/PhoneMirror.Core/Services/AdbService.cs
@src/PhoneMirror.Core/Execution/ProcessRunner.cs
@src/PhoneMirror/ViewModels/MainWindowViewModel.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IScreenshotService interface and ScreenshotService implementation</name>
  <files>src/PhoneMirror.Core/Services/IScreenshotService.cs, src/PhoneMirror.Core/Services/ScreenshotService.cs</files>
  <action>
Create IScreenshotService interface with single method:
- `Task<(bool Success, string? Error)> CaptureToClipboardAsync(string deviceSerial, CancellationToken ct = default)`

Create ScreenshotService implementation:
1. Constructor takes ProcessRunner, IAdbService (for AdbPath resolution)
2. Use `adb -s {serial} exec-out screencap -p` to capture PNG to stdout
3. Use ProcessRunner.RunAsync to capture binary output (screencap outputs PNG bytes)
4. Return (false, error) if ADB fails or no device

NOTE: Binary capture requires modifying ProcessRunner or using Process directly since RunAsync captures as string. For now, use Process directly with MemoryStream to capture PNG bytes. Follow ScrcpyService pattern (Process for long-running/binary, ProcessRunner for text output).

ADB screencap command: `adb -s {serial} exec-out screencap -p` outputs raw PNG to stdout.
  </action>
  <verify>Build succeeds with `dotnet build src/PhoneMirror.Core`</verify>
  <done>IScreenshotService interface and ScreenshotService created with ADB screencap integration</done>
</task>

<task type="auto">
  <name>Task 2: Add clipboard integration to ScreenshotService</name>
  <files>src/PhoneMirror.Core/Services/ScreenshotService.cs</files>
  <action>
After capturing PNG bytes from ADB:
1. Create Avalonia.Media.Imaging.Bitmap from PNG bytes using MemoryStream
2. Create Avalonia DataObject with bitmap
3. Use Avalonia.Input.Clipboard.SetDataObjectAsync to copy to system clipboard

NOTE: Clipboard operations need to run on UI thread. The service should accept a callback or use Dispatcher.UIThread.InvokeAsync for clipboard access.

Alternative approach: Return the byte array from service, let ViewModel handle clipboard (cleaner separation). Service method becomes:
- `Task<(byte[]? PngData, string? Error)> CaptureAsync(string deviceSerial, CancellationToken ct = default)`

ViewModel handles clipboard write using Avalonia.Input.Platform.IClipboard via TopLevel.GetTopLevel(view)?.Clipboard.
  </action>
  <verify>Build succeeds</verify>
  <done>Screenshot bytes can be captured; clipboard integration prepared for ViewModel</done>
</task>

<task type="auto">
  <name>Task 3: Register ScreenshotService and add screenshot command to ViewModel</name>
  <files>src/PhoneMirror/App.axaml.cs, src/PhoneMirror/ViewModels/MainWindowViewModel.cs</files>
  <action>
1. Register IScreenshotService in App.axaml.cs ConfigureServices:
   `services.AddSingleton&lt;IScreenshotService, ScreenshotService&gt;()`

2. Add IScreenshotService to MainWindowViewModel constructor

3. Add ScreenshotCommand using [RelayCommand]:
   - Only enabled when device is connected (_currentDevice != null)
   - Calls ScreenshotService.CaptureAsync
   - Writes PNG bytes to clipboard using Avalonia clipboard API
   - Updates StatusText on success ("Screenshot copied to clipboard") or failure

4. For clipboard access in ViewModel, use static method:
   ```csharp
   var clipboard = App.Current?.ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop
       ? desktop.MainWindow?.Clipboard
       : null;
   if (clipboard != null && pngData != null)
   {
       using var stream = new MemoryStream(pngData);
       var bitmap = new Avalonia.Media.Imaging.Bitmap(stream);
       var dataObject = new DataObject();
       dataObject.Set(DataFormats.Bitmap, bitmap);
       await clipboard.SetDataObjectAsync(dataObject);
   }
   ```
  </action>
  <verify>Build succeeds with `dotnet build src/PhoneMirror`</verify>
  <done>ScreenshotService registered, ScreenshotCommand added to ViewModel</done>
</task>

<task type="auto">
  <name>Task 4: Add screenshot button to MainWindow UI</name>
  <files>src/PhoneMirror/Views/MainWindow.axaml</files>
  <action>
Add a screenshot button in the right panel near the Mirror button:
1. Add Button with camera icon (use FluentAvalonia Symbol or Unicode)
2. Bind Command="{Binding ScreenshotCommand}"
3. ToolTip="Capture screenshot to clipboard"
4. Style as secondary action (smaller than Mirror button, complementary placement)
5. Place below Mirror button or as a small icon button in the device summary area

The button should be visible but not compete with the hero Mirror button for attention.
  </action>
  <verify>Build and run app, verify screenshot button appears and is clickable when device connected</verify>
  <done>Screenshot button visible in UI, bound to ScreenshotCommand</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors
- [ ] Screenshot button appears in MainWindow
- [ ] Clicking button with device connected captures screenshot
- [ ] Screenshot appears in system clipboard (can paste into Paint/Preview)
- [ ] Status shows "Screenshot copied to clipboard" on success
</verification>

<success_criteria>
- IScreenshotService interface created
- ScreenshotService captures via ADB screencap
- Screenshot command in ViewModel with clipboard integration
- Button in UI triggers screenshot
- CAPT-01 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-capture-features/04-01-SUMMARY.md`
</output>
