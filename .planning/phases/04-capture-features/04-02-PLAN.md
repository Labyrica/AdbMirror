---
phase: 04-capture-features
plan: 02
type: execute
wave: 2
depends_on: ["04-01", "04-03"]
files_modified:
  - src/PhoneMirror/Views/FloatingToolbar.axaml
  - src/PhoneMirror/Views/FloatingToolbar.axaml.cs
  - src/PhoneMirror/ViewModels/FloatingToolbarViewModel.cs
  - src/PhoneMirror/ViewModels/MainWindowViewModel.cs
  - src/PhoneMirror/App.axaml.cs
autonomous: true
---

<objective>
Create floating toolbar window that appears during active mirroring sessions.

Purpose: Provide quick access to screenshot and error capture without switching away from the mirrored display.
Output: Floating toolbar with screenshot button and copy-recent-errors button. Appears near mirror window when mirroring starts, disappears when mirroring stops.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-capture-features/04-01-SUMMARY.md
@.planning/phases/04-capture-features/04-03-SUMMARY.md

@src/PhoneMirror/ViewModels/MainWindowViewModel.cs
@src/PhoneMirror/Views/MainWindow.axaml
@src/PhoneMirror.Core/Services/IScreenshotService.cs
@src/PhoneMirror.Core/Services/ILogcatService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FloatingToolbarViewModel</name>
  <files>src/PhoneMirror/ViewModels/FloatingToolbarViewModel.cs</files>
  <action>
Create FloatingToolbarViewModel with:

1. Constructor takes IScreenshotService, ILogcatService, and device serial (string)
2. Store _deviceSerial for screenshot command

3. ScreenshotCommand using [RelayCommand]:
   - Calls IScreenshotService.CaptureAsync(_deviceSerial)
   - Writes to clipboard (same pattern as MainWindowViewModel)
   - Shows brief success indicator

4. CopyErrorsCommand using [RelayCommand]:
   - Calls ILogcatService.GetRecentErrors()
   - Formats errors as text (timestamp, level, tag, message - one per line)
   - Copies formatted text to clipboard
   - Shows brief success indicator

5. Observable property for status feedback (brief toast/status):
   - `_statusMessage` string shown for 2 seconds then cleared

The ViewModel should be lightweight - just commands and status.
  </action>
  <verify>Build succeeds</verify>
  <done>FloatingToolbarViewModel with screenshot and error copy commands</done>
</task>

<task type="auto">
  <name>Task 2: Create FloatingToolbar window XAML</name>
  <files>src/PhoneMirror/Views/FloatingToolbar.axaml, src/PhoneMirror/Views/FloatingToolbar.axaml.cs</files>
  <action>
Create floating toolbar window:

**FloatingToolbar.axaml:**
1. Window with compact dimensions (~150x60)
2. Dark theme matching main app (FluentAvalonia)
3. SystemDecorations="None" for borderless look
4. Topmost="True" to stay above other windows
5. CanResize="False"
6. Background with rounded corners (Border with CornerRadius)

7. Horizontal StackPanel with two icon buttons:
   - Camera icon button: Command="{Binding ScreenshotCommand}" ToolTip="Screenshot to clipboard"
   - Error icon button: Command="{Binding CopyErrorsCommand}" ToolTip="Copy recent errors"

8. Small status TextBlock at bottom (shows brief feedback)

**FloatingToolbar.axaml.cs:**
1. Simple code-behind with InitializeComponent()
2. No complex logic - all in ViewModel

**Styling:**
- Semi-transparent dark background (80% opacity)
- Icon buttons ~32x32
- Minimal padding
- Subtle shadow/border for visibility

Position will be set by MainWindowViewModel when showing the toolbar.
  </action>
  <verify>Build succeeds</verify>
  <done>FloatingToolbar window created with buttons and dark theme</done>
</task>

<task type="auto">
  <name>Task 3: Wire toolbar lifecycle to mirroring state</name>
  <files>src/PhoneMirror/ViewModels/MainWindowViewModel.cs, src/PhoneMirror/App.axaml.cs</files>
  <action>
1. Add fields to MainWindowViewModel:
   - `private FloatingToolbar? _floatingToolbar`
   - `private readonly ILogcatService _logcatService` (add to constructor)

2. In MirrorAsync() when starting mirroring:
   - Start logcat capture: `await _logcatService.StartCaptureAsync(_currentDevice!.Serial)`
   - Create FloatingToolbarViewModel with services and serial
   - Create FloatingToolbar window with ViewModel as DataContext
   - Position toolbar (e.g., screen right edge, vertically centered, or near MainWindow)
   - Show toolbar: `_floatingToolbar.Show()`

3. In MirrorAsync() when stopping mirroring:
   - Stop logcat capture: `_logcatService.StopCapture()`
   - Close and dispose toolbar: `_floatingToolbar?.Close(); _floatingToolbar = null`

4. In OnMirroringStopped handler:
   - Same cleanup: stop logcat, close toolbar

5. In Dispose():
   - Close toolbar if open

**Positioning strategy:**
Simple approach: Position 20px from right edge of screen, vertically centered.
```csharp
var screen = Screens.Primary;
if (screen != null)
{
    _floatingToolbar.Position = new PixelPoint(
        screen.WorkingArea.Right - _floatingToolbar.Width - 20,
        (screen.WorkingArea.Height - _floatingToolbar.Height) / 2
    );
}
```
  </action>
  <verify>Build succeeds, toolbar appears when mirroring starts, disappears when stopped</verify>
  <done>Floating toolbar shows during active mirroring sessions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors
- [ ] Start mirroring → toolbar appears
- [ ] Stop mirroring → toolbar disappears
- [ ] Screenshot button captures to clipboard
- [ ] Copy errors button copies recent logcat errors
- [ ] Toolbar stays on top of other windows
- [ ] Toolbar has dark theme matching main app
</verification>

<success_criteria>
- FloatingToolbar window created with dark theme
- Screenshot button works from toolbar
- Copy errors button copies recent logcat entries
- Toolbar lifecycle tied to mirroring state
- CAPT-02, CAPT-03, CAPT-04 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-capture-features/04-02-SUMMARY.md`
</output>
