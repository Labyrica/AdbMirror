---
phase: 04-capture-features
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/PhoneMirror.Core/Services/ILogcatService.cs
  - src/PhoneMirror.Core/Services/LogcatService.cs
  - src/PhoneMirror/App.axaml.cs
autonomous: true
---

<objective>
Implement session-scoped logcat error capture during mirroring.

Purpose: Capture device errors that occur during mirroring so users can diagnose issues or share error logs with developers.
Output: ILogcatService that runs `adb logcat` filtered for errors, storing recent entries (last 10 seconds) in a circular buffer.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-services/02-02-SUMMARY.md

@src/PhoneMirror.Core/Services/IAdbService.cs
@src/PhoneMirror.Core/Execution/ProcessRunner.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ILogcatService interface</name>
  <files>src/PhoneMirror.Core/Services/ILogcatService.cs</files>
  <action>
Create ILogcatService interface for session-scoped logcat capture:

```csharp
public interface ILogcatService
{
    /// <summary>
    /// Whether logcat capture is currently running.
    /// </summary>
    bool IsCapturing { get; }

    /// <summary>
    /// Starts capturing logcat errors for the specified device.
    /// Only captures errors (*:E filter).
    /// </summary>
    Task StartCaptureAsync(string deviceSerial, CancellationToken ct = default);

    /// <summary>
    /// Stops the current capture session.
    /// </summary>
    void StopCapture();

    /// <summary>
    /// Gets recent error entries (last 10 seconds).
    /// Returns empty collection if not capturing.
    /// </summary>
    IReadOnlyList<LogcatEntry> GetRecentErrors();

    /// <summary>
    /// Gets all captured errors from the current session.
    /// </summary>
    IReadOnlyList<LogcatEntry> GetAllSessionErrors();

    /// <summary>
    /// Clears all captured errors.
    /// </summary>
    void ClearErrors();
}
```

Also create LogcatEntry model:
```csharp
public record LogcatEntry(DateTime Timestamp, string Level, string Tag, string Message);
```
  </action>
  <verify>Build succeeds</verify>
  <done>ILogcatService interface and LogcatEntry model created</done>
</task>

<task type="auto">
  <name>Task 2: Implement LogcatService with circular buffer</name>
  <files>src/PhoneMirror.Core/Services/LogcatService.cs</files>
  <action>
Create LogcatService implementation:

1. Constructor takes IAdbService (for AdbPath)
2. Use `adb -s {serial} logcat *:E` to capture only Error level
3. Run logcat as a long-running process (like ScrcpyService pattern)
4. Parse each line into LogcatEntry (format: "MM-DD HH:MM:SS.mmm LEVEL/TAG: message")
5. Store entries in a ConcurrentQueue with timestamp
6. GetRecentErrors() filters for entries within last 10 seconds
7. StopCapture() kills the logcat process

Logcat line format: `01-15 12:34:56.789 E/Tag: message`
Use regex to parse: `^(\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d{3})\s+([VDIWEF])/([^:]+):\s*(.*)$`

For circular buffer (max 1000 entries):
- Use ConcurrentQueue<LogcatEntry>
- When adding, if Count > 1000, TryDequeue to remove oldest
- Thread-safe for async logcat reading

Process management:
- Store Process reference for cleanup
- BeginOutputReadLine() for async line reading
- OutputDataReceived event to parse and store entries
  </action>
  <verify>Build succeeds with `dotnet build src/PhoneMirror.Core`</verify>
  <done>LogcatService captures errors with 10-second window filtering</done>
</task>

<task type="auto">
  <name>Task 3: Register LogcatService and wire to mirroring lifecycle</name>
  <files>src/PhoneMirror/App.axaml.cs</files>
  <action>
1. Register ILogcatService in ConfigureServices:
   `services.AddSingleton<ILogcatService, LogcatService>()`

NOTE: The actual integration with mirroring lifecycle (start/stop logcat when mirror starts/stops) will be done in 04-02 when we add the floating toolbar. For now, just register the service.

The service is ready to be called from:
- MainWindowViewModel.MirrorAsync() when starting (StartCaptureAsync)
- OnMirroringStopped handler when stopping (StopCapture)
- Floating toolbar for GetRecentErrors()

This plan establishes the service foundation. Plan 04-02 will integrate it with the UI.
  </action>
  <verify>Build succeeds, app starts without errors</verify>
  <done>LogcatService registered in DI container</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build` succeeds without errors
- [ ] ILogcatService interface with all methods defined
- [ ] LogcatService parses logcat output correctly
- [ ] Circular buffer limits entries to max 1000
- [ ] GetRecentErrors() filters to last 10 seconds
- [ ] Service registered in DI container
</verification>

<success_criteria>
- ILogcatService interface created
- LogcatService captures logcat errors
- Circular buffer with 10-second window
- LOGS-01 requirement foundation in place
</success_criteria>

<output>
After completion, create `.planning/phases/04-capture-features/04-03-SUMMARY.md`
</output>
