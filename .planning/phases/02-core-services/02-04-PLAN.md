---
phase: 02-core-services
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/PhoneMirror.Core/Services/IResourceExtractor.cs, src/PhoneMirror.Core/Services/ResourceExtractor.cs]
autonomous: true
---

<objective>
Create cross-platform resource extraction for bundled ADB and scrcpy binaries.

Purpose: Enable zero-setup experience (PLAT-02) by extracting bundled tools with proper permissions.
Output: IResourceExtractor interface and implementation with platform-specific permission handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-services/02-01-SUMMARY.md
@.planning/research/PITFALLS.md

Reference existing WPF implementation:
@AdbMirror/Core/ResourceExtractor.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IResourceExtractor interface</name>
  <files>src/PhoneMirror.Core/Services/IResourceExtractor.cs</files>
  <action>
Create IResourceExtractor interface:
```csharp
namespace PhoneMirror.Core.Services;

public interface IResourceExtractor
{
    /// <summary>
    /// Gets the path to extracted ADB executable, or null if not bundled.
    /// </summary>
    Task<string?> GetAdbPathAsync();

    /// <summary>
    /// Gets the path to extracted scrcpy executable, or null if not bundled.
    /// </summary>
    Task<string?> GetScrcpyPathAsync();

    /// <summary>
    /// Extracts all bundled resources. Call on app startup.
    /// </summary>
    Task ExtractAllAsync();

    /// <summary>
    /// Cleans up extracted resources. Call on app exit.
    /// </summary>
    void Cleanup();
}
```

Interface is async because extraction may involve chmod/xattr operations.
  </action>
  <verify>dotnet build src/PhoneMirror.Core</verify>
  <done>IResourceExtractor interface defined</done>
</task>

<task type="auto">
  <name>Task 2: Create ResourceExtractor implementation</name>
  <files>src/PhoneMirror.Core/Services/ResourceExtractor.cs</files>
  <action>
Create ResourceExtractor class:
- Constructor takes IPlatformService
- Store extracted base path (lazy initialized)
- Thread-safe extraction using SemaphoreSlim

ExtractAllAsync() implementation:
1. Create extraction directory: `{TempPath}/PhoneMirror/{random8chars}`
2. Extract embedded "platform-tools.zip" to platform-tools subfolder
3. Extract embedded "scrcpy.zip" to scrcpy subfolder
4. CRITICAL: After extraction on Linux/macOS:
   - Call IPlatformService.SetExecutablePermissionAsync() on adb/scrcpy binaries
   - Call IPlatformService.RemoveQuarantineAsync() on macOS

GetAdbPathAsync() implementation:
- Ensure ExtractAllAsync() has been called (via lazy init)
- Return path to adb{.exe} if exists, null otherwise
- Path format: `{basePath}/platform-tools/adb{IPlatformService.ExecutableExtension}`

GetScrcpyPathAsync() implementation:
- Ensure ExtractAllAsync() has been called
- Return path to scrcpy{.exe} if exists, null otherwise
- Path format: `{basePath}/scrcpy/scrcpy{IPlatformService.ExecutableExtension}`

Cleanup() implementation:
- Delete extraction directory recursively if exists
- Wrap in try/catch (best effort, may fail if processes still running)

Embedded resource handling:
- Use Assembly.GetExecutingAssembly().GetManifestResourceStream()
- Resource name format: "PhoneMirror.Core.Resources.{filename}"
- If resource not found, return null (not bundled = fall back to PATH)
- Use ZipArchive for extraction

IMPORTANT from PITFALLS.md:
- Linux needs chmod +x on extracted binaries
- macOS needs xattr -d com.apple.quarantine removal
- These are handled by IPlatformService methods
  </action>
  <verify>dotnet build src/PhoneMirror.Core</verify>
  <done>ResourceExtractor handles cross-platform extraction with permission fixes</done>
</task>

<task type="auto">
  <name>Task 3: Register ResourceExtractor and wire up lifecycle</name>
  <files>src/PhoneMirror/App.axaml.cs</files>
  <action>
Add to ConfigureServices:
```csharp
services.AddSingleton<IResourceExtractor, ResourceExtractor>();
```

In OnFrameworkInitializationCompleted():
- Get IResourceExtractor from services
- Call ExtractAllAsync() (fire and forget, or await if blocking acceptable)
- Store reference for cleanup

Add cleanup on app exit (or let temp directory handle it).

Note: Actual bundling of platform-tools.zip and scrcpy.zip is a packaging concern (Phase 6).
For now, the code handles "not bundled" gracefully by returning null paths.
  </action>
  <verify>dotnet build src/PhoneMirror && dotnet run --project src/PhoneMirror</verify>
  <done>ResourceExtractor registered and initialized at app startup</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build src/PhoneMirror.Core` succeeds
- [ ] `dotnet build src/PhoneMirror` succeeds
- [ ] App starts without errors (even without bundled resources)
- [ ] ResourceExtractor returns null for non-bundled resources (graceful fallback)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- ResourceExtractor ready for bundled binaries (actual bundling in Phase 6)
- Requirements PLAT-02, PLAT-03 foundations in place
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-services/02-04-SUMMARY.md`
</output>
