---
phase: 02-core-services
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/PhoneMirror.Core/Models/ScrcpyPreset.cs, src/PhoneMirror.Core/Services/IScrcpyService.cs, src/PhoneMirror.Core/Services/ScrcpyService.cs]
autonomous: true
---

<objective>
Migrate ScrcpyService to PhoneMirror.Core with cross-platform process management.

Purpose: Enable screen mirroring with quality presets using cross-platform ProcessRunner.
Output: IScrcpyService interface, ScrcpyService with quality presets and process lifecycle management.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-services/02-01-SUMMARY.md

Reference existing WPF implementation:
@AdbMirror/Core/ScrcpyService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScrcpyPreset enum</name>
  <files>src/PhoneMirror.Core/Models/ScrcpyPreset.cs</files>
  <action>
Create ScrcpyPreset enum (migrate from WPF):
```csharp
namespace PhoneMirror.Core.Models;

public enum ScrcpyPreset
{
    Low,      // 4M bitrate, 1024 max-size, 30fps
    Balanced, // 8M bitrate, 1280 max-size, 60fps
    High      // 16M bitrate, 1920 max-size, 60fps
}
```

This covers requirement MIRR-02 (quality preset selection).
  </action>
  <verify>dotnet build src/PhoneMirror.Core</verify>
  <done>ScrcpyPreset enum exists in PhoneMirror.Core.Models</done>
</task>

<task type="auto">
  <name>Task 2: Create IScrcpyService interface and ScrcpyService implementation</name>
  <files>src/PhoneMirror.Core/Services/IScrcpyService.cs, src/PhoneMirror.Core/Services/ScrcpyService.cs</files>
  <action>
Create IScrcpyService interface:
```csharp
public interface IScrcpyService
{
    string? ScrcpyPath { get; }
    bool IsMirroring { get; }
    Task<bool> IsAvailableAsync();
    Task<(bool Success, string? Error)> StartMirroringAsync(
        string deviceSerial,
        ScrcpyPreset preset,
        bool keepScreenAwake,
        CancellationToken cancellationToken = default);
    void StopMirroring();
    event EventHandler<string>? MirroringStopped;
}
```

Create ScrcpyService implementation:
- Constructor takes IPlatformService, IResourceExtractor (optional, for bundled scrcpy)
- Store resolved scrcpy path (cross-platform: scrcpy.exe on Windows, scrcpy on Unix)
- Track current process reference (nullable)

StartMirroringAsync() implementation:
- First call StopMirroring() to clean up any existing session
- Check IsAvailableAsync() first
- Build arguments from preset and options:
  ```
  -s "SERIAL" --video-bit-rate XM --max-size Y --max-fps Z
  ```
- Add --stay-awake if keepScreenAwake is true
- Add --turn-screen-off for screen saving (requires control enabled)
- Use ProcessStartInfo with:
  - UseShellExecute = false
  - CreateNoWindow = true
  - RedirectStandardOutput = true
  - RedirectStandardError = true
  - WorkingDirectory = directory containing scrcpy (for DLL dependencies)
- Start process and store reference
- Attach async exit handler that:
  - Captures stderr/stdout for error reporting
  - Raises MirroringStopped event with status message
  - Cleans up process reference

StopMirroring() implementation:
- If process exists and hasn't exited, Kill() it
- Dispose process reference
- Set to null

IMPORTANT: Unlike ProcessRunner (short-lived commands), scrcpy is long-running.
Use Process directly with EnableRaisingEvents = true for exit notification.
Do NOT use ProcessRunner here - it's designed for command execution with output capture.
  </action>
  <verify>dotnet build src/PhoneMirror.Core</verify>
  <done>IScrcpyService and ScrcpyService ready with quality presets and lifecycle management</done>
</task>

<task type="auto">
  <name>Task 3: Register ScrcpyService in DI</name>
  <files>src/PhoneMirror/App.axaml.cs</files>
  <action>
Add to ConfigureServices:
```csharp
services.AddSingleton<IScrcpyService, ScrcpyService>();
```

Make IResourceExtractor optional in constructor for now (Plan 04 dependency).
  </action>
  <verify>dotnet build src/PhoneMirror</verify>
  <done>ScrcpyService registered in DI, app builds successfully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build src/PhoneMirror.Core` succeeds
- [ ] `dotnet build src/PhoneMirror` succeeds
- [ ] ScrcpyPreset covers all three quality levels
- [ ] ScrcpyService uses proper process lifecycle (start/stop/exit event)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- ScrcpyService ready to start mirroring (integration test in Phase 3)
- Requirements MIRR-01, MIRR-02, MIRR-03 foundations in place
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-services/02-03-SUMMARY.md`
</output>
