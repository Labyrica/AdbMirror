---
phase: 02-core-services
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/PhoneMirror.Core/Models/AndroidDevice.cs, src/PhoneMirror.Core/Models/DeviceState.cs, src/PhoneMirror.Core/Services/IAdbService.cs, src/PhoneMirror.Core/Services/AdbService.cs]
autonomous: true
---

<objective>
Migrate AdbService to PhoneMirror.Core with cross-platform device detection.

Purpose: Enable device discovery and state management using the cross-platform ProcessRunner from Plan 01.
Output: IAdbService interface, AdbService with device polling, models for AndroidDevice and DeviceState.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-services/02-01-SUMMARY.md

Reference existing WPF implementation:
@AdbMirror/Core/AdbService.cs
@AdbMirror/Models/AndroidDevice.cs
@AdbMirror/Core/DeviceState.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create device models</name>
  <files>src/PhoneMirror.Core/Models/AndroidDevice.cs, src/PhoneMirror.Core/Models/DeviceState.cs</files>
  <action>
Create AndroidDevice record (migrate from WPF):
```csharp
namespace PhoneMirror.Core.Models;

public record AndroidDevice(string Serial, string Model, string StateRaw)
{
    public string DisplayName => string.IsNullOrEmpty(Model) ? Serial : Model;
}
```

Create DeviceState enum (migrate from WPF):
```csharp
namespace PhoneMirror.Core.Models;

public enum DeviceState
{
    NoDevice,
    Unauthorized,
    Offline,
    Connected,
    MultipleDevices,
    AdbNotAvailable,
    ScrcpyNotAvailable,
    Mirroring
}
```

Use records for immutability. Add DisplayName computed property for CONN-04 (friendly device name).
  </action>
  <verify>dotnet build src/PhoneMirror.Core</verify>
  <done>AndroidDevice and DeviceState models exist in PhoneMirror.Core.Models namespace</done>
</task>

<task type="auto">
  <name>Task 2: Create IAdbService interface and AdbService implementation</name>
  <files>src/PhoneMirror.Core/Services/IAdbService.cs, src/PhoneMirror.Core/Services/AdbService.cs</files>
  <action>
Create IAdbService interface:
```csharp
public interface IAdbService
{
    string? AdbPath { get; }
    Task<bool> IsAvailableAsync();
    Task EnsureServerRunningAsync();
    Task<IReadOnlyList<AndroidDevice>> GetDevicesAsync();
    Task<(DeviceState State, AndroidDevice? Device)> GetHighLevelStateAsync();
    Task StartPollingAsync(TimeSpan interval, Action<DeviceState, AndroidDevice?> observer, CancellationToken cancellationToken);
}
```

Create AdbService implementation:
- Constructor takes ProcessRunner, IPlatformService, IResourceExtractor (from Plan 04)
- Store resolved ADB path (use IResourceExtractor.GetAdbPath() first, then fallback to PATH)
- Cross-platform path resolution:
  - Windows: adb.exe
  - Linux/macOS: adb (no extension)
  - Use IPlatformService.ExecutableExtension

GetDevicesAsync() implementation:
- Run "adb devices -l" via ProcessRunner.RunAsync()
- Parse output line by line (skip "List of devices" header)
- Extract serial, state, model from output format: "SERIAL STATE device product:X model:Y"
- Return list of AndroidDevice records

GetHighLevelStateAsync() implementation:
- Check IsAvailableAsync() first
- Call GetDevicesAsync()
- Map device count and state to DeviceState enum
- Return primary device (first in list) for single/multiple device scenarios

StartPollingAsync() implementation:
- Run loop calling GetHighLevelStateAsync() at interval
- Invoke observer callback on each poll
- Use try/catch to keep polling resilient
- Respect CancellationToken for clean shutdown

CRITICAL: All Process execution goes through ProcessRunner (async dual-stream pattern).
  </action>
  <verify>dotnet build src/PhoneMirror.Core</verify>
  <done>IAdbService interface and AdbService implementation ready for DI registration</done>
</task>

<task type="auto">
  <name>Task 3: Register AdbService in DI and verify</name>
  <files>src/PhoneMirror/App.axaml.cs</files>
  <action>
Add to ConfigureServices:
```csharp
services.AddSingleton<IAdbService, AdbService>();
```

Note: This task depends on Plan 04 completing IResourceExtractor registration. For now, make IResourceExtractor optional in AdbService constructor (null = skip embedded resource check).
  </action>
  <verify>dotnet build src/PhoneMirror</verify>
  <done>AdbService registered in DI, app builds and starts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build src/PhoneMirror.Core` succeeds
- [ ] `dotnet build src/PhoneMirror` succeeds
- [ ] AndroidDevice.DisplayName returns model when available, serial otherwise
- [ ] AdbService uses ProcessRunner for all process execution
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- AdbService ready to detect devices (integration test in Phase 3)
- Requirements CONN-01, CONN-03, CONN-04 foundations in place
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-services/02-02-SUMMARY.md`
</output>
