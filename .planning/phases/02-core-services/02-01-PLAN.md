---
phase: 02-core-services
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/PhoneMirror.Core/Platform/IPlatformService.cs, src/PhoneMirror.Core/Platform/PlatformService.cs, src/PhoneMirror.Core/Process/ProcessRunner.cs, src/PhoneMirror.Core/Process/ProcessResult.cs]
autonomous: true
---

<objective>
Create cross-platform abstractions for process execution and platform detection.

Purpose: Foundation for all external tool (ADB/scrcpy) execution with proper async handling and cross-platform path resolution.
Output: IPlatformService interface, PlatformService implementation, ProcessRunner with async dual-stream reading.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-scaffold/01-01-SUMMARY.md
@.planning/research/PITFALLS.md

Reference existing WPF implementation:
@AdbMirror/Core/AdbService.cs (RunAdbCommandRaw pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform abstraction interfaces and implementation</name>
  <files>src/PhoneMirror.Core/Platform/IPlatformService.cs, src/PhoneMirror.Core/Platform/PlatformService.cs</files>
  <action>
Create IPlatformService interface with:
- `OSPlatform CurrentPlatform { get; }` - Returns Windows/Linux/OSX
- `string ExecutableExtension { get; }` - Returns ".exe" on Windows, "" on Unix
- `string GetAppDataPath()` - Platform-appropriate settings location
- `string GetTempPath()` - Platform-appropriate temp directory
- `Task SetExecutablePermissionAsync(string path)` - chmod +x on Unix, no-op on Windows
- `Task RemoveQuarantineAsync(string path)` - xattr removal on macOS, no-op elsewhere

Implementation notes:
- Use RuntimeInformation.IsOSPlatform() for detection
- Use Environment.GetFolderPath(SpecialFolder.LocalApplicationData) on Windows
- Use ~/.config/PhoneMirror on Linux, ~/Library/Application Support/PhoneMirror on macOS
- SetExecutablePermission: Process.Start("chmod", "+x path") on Linux/macOS
- RemoveQuarantine: Process.Start("xattr", "-d com.apple.quarantine path") on macOS only
- Inject via DI as singleton
  </action>
  <verify>dotnet build src/PhoneMirror.Core</verify>
  <done>IPlatformService interface exists with PlatformService implementation, handles Windows/Linux/macOS correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create ProcessRunner with async dual-stream handling</name>
  <files>src/PhoneMirror.Core/Process/ProcessRunner.cs, src/PhoneMirror.Core/Process/ProcessResult.cs</files>
  <action>
Create ProcessResult record:
```csharp
public record ProcessResult(int ExitCode, string StandardOutput, string StandardError);
```

Create ProcessRunner class with:
- Constructor takes IPlatformService dependency
- `Task<ProcessResult> RunAsync(string executable, string arguments, TimeSpan? timeout = null, CancellationToken cancellationToken = default)`

Implementation CRITICAL - follow PITFALLS.md patterns:
1. ALWAYS use absolute paths for FileName (no reliance on PATH)
2. UseShellExecute = false (required for redirection)
3. RedirectStandardOutput = true, RedirectStandardError = true
4. CreateNoWindow = true
5. Async dual-stream reading to prevent deadlock:
   ```csharp
   var outputTask = process.StandardOutput.ReadToEndAsync();
   var errorTask = process.StandardError.ReadToEndAsync();
   await Task.WhenAll(outputTask, errorTask);
   await process.WaitForExitAsync();
   ```
6. NEVER do process.WaitForExit() before reading streams
7. Support timeout via CancellationToken combined with process.WaitForExitAsync
8. On timeout, kill process and return error result
9. StandardOutputEncoding and StandardErrorEncoding = Encoding.UTF8
  </action>
  <verify>dotnet build src/PhoneMirror.Core</verify>
  <done>ProcessRunner handles async execution without deadlocks, returns ProcessResult with captured output</done>
</task>

<task type="auto">
  <name>Task 3: Register services in DI container</name>
  <files>src/PhoneMirror/App.axaml.cs</files>
  <action>
Update ConfigureServices in App.axaml.cs to register:
```csharp
services.AddSingleton<IPlatformService, PlatformService>();
services.AddSingleton<ProcessRunner>();
```

Ensure PhoneMirror project references PhoneMirror.Core project (should already exist from Phase 1).
  </action>
  <verify>dotnet build src/PhoneMirror</verify>
  <done>Services registered in DI, app builds successfully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build src/PhoneMirror.Core` succeeds
- [ ] `dotnet build src/PhoneMirror` succeeds
- [ ] IPlatformService correctly detects current OS
- [ ] ProcessRunner uses async dual-stream pattern (no deadlock risk)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No build errors or warnings
- Platform abstraction ready for AdbService/ScrcpyService to use
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-services/02-01-SUMMARY.md`
</output>
