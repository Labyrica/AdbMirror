---
phase: 06-packaging
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - scripts/publish-linux.ps1
  - packaging/linux/PhoneMirror.desktop
  - packaging/linux/AppRun
autonomous: false
user_setup:
  - service: platform-tools-linux
    why: "Linux-specific ADB binaries"
    download:
      - url: "https://dl.google.com/android/repository/platform-tools-latest-linux.zip"
        destination: "src/PhoneMirror.Core/Resources/platform-tools/"
  - service: scrcpy-linux
    why: "Linux-specific scrcpy binary"
    download:
      - url: "https://github.com/Genymobile/scrcpy/releases"
        instruction: "Download or build scrcpy for Linux"
        destination: "src/PhoneMirror.Core/Resources/scrcpy/"
---

<objective>
Create Linux AppImage for portable distribution.

Purpose: Package Phone Mirror as an AppImage that runs on most Linux distributions without installation.
Output: publish-linux.ps1 script, .desktop file, AppRun script, AppImage output.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-packaging/06-01-SUMMARY.md

@src/PhoneMirror/PhoneMirror.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Linux desktop entry and AppRun script</name>
  <files>packaging/linux/PhoneMirror.desktop, packaging/linux/AppRun</files>
  <action>
Create Linux packaging files:

**1. Create packaging/linux/ directory**

**2. Create PhoneMirror.desktop:**

```desktop
[Desktop Entry]
Type=Application
Name=Phone Mirror
Comment=One-click Android screen mirroring
Exec=PhoneMirror
Icon=phonemirror
Terminal=false
Categories=Development;Utility;
Keywords=android;mirror;screen;adb;scrcpy;
StartupWMClass=PhoneMirror
```

**3. Create AppRun script:**

```bash
#!/bin/bash
# AppRun - Entry point for AppImage

SELF=$(readlink -f "$0")
HERE=${SELF%/*}

# Set library paths for .NET runtime
export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"

# Launch the application
exec "${HERE}/usr/bin/PhoneMirror" "$@"
```

Mark AppRun as executable when creating AppImage.
  </action>
  <verify>Both files created in packaging/linux/</verify>
  <done>Desktop entry and AppRun script created</done>
</task>

<task type="auto">
  <name>Task 2: Create Linux publish script with AppImage support</name>
  <files>scripts/publish-linux.ps1</files>
  <action>
Create PowerShell script for Linux AppImage creation:

```powershell
# publish-linux.ps1
# Builds Phone Mirror for Linux and creates AppImage
# Can be run on Linux or in WSL

param(
    [string]$Configuration = "Release",
    [string]$Runtime = "linux-x64",
    [string]$OutputPath = "$PSScriptRoot/../publish/linux",
    [switch]$SkipAppImage
)

$ErrorActionPreference = "Stop"
$ProjectPath = "$PSScriptRoot/../src/PhoneMirror/PhoneMirror.csproj"
$PackagingPath = "$PSScriptRoot/../packaging/linux"
$AppDir = "$OutputPath/PhoneMirror.AppDir"

Write-Host "Publishing Phone Mirror for Linux..."
Write-Host "Configuration: $Configuration"
Write-Host "Runtime: $Runtime"
Write-Host ""

# Clean output directory
if (Test-Path $OutputPath) {
    Remove-Item -Recurse -Force $OutputPath
}

# Publish .NET app
Write-Host "Building application..."
dotnet publish $ProjectPath `
    -c $Configuration `
    -r $Runtime `
    --self-contained true `
    -o "$OutputPath/bin"

if ($LASTEXITCODE -ne 0) {
    Write-Error "Publish failed!"
    exit 1
}

if ($SkipAppImage) {
    Write-Host ""
    Write-Host "Build complete (AppImage skipped)!"
    Write-Host "Output: $OutputPath/bin"
    exit 0
}

# Create AppDir structure
Write-Host "Creating AppDir structure..."
New-Item -ItemType Directory -Force -Path "$AppDir/usr/bin" | Out-Null
New-Item -ItemType Directory -Force -Path "$AppDir/usr/lib" | Out-Null
New-Item -ItemType Directory -Force -Path "$AppDir/usr/share/applications" | Out-Null
New-Item -ItemType Directory -Force -Path "$AppDir/usr/share/icons/hicolor/256x256/apps" | Out-Null

# Copy application files
Copy-Item "$OutputPath/bin/*" "$AppDir/usr/bin/" -Recurse

# Copy desktop entry
Copy-Item "$PackagingPath/PhoneMirror.desktop" "$AppDir/usr/share/applications/"
Copy-Item "$PackagingPath/PhoneMirror.desktop" "$AppDir/"

# Copy AppRun
Copy-Item "$PackagingPath/AppRun" "$AppDir/"

# Copy icon (placeholder - use actual icon if available)
# Copy-Item "path/to/icon.png" "$AppDir/usr/share/icons/hicolor/256x256/apps/phonemirror.png"
# Copy-Item "path/to/icon.png" "$AppDir/phonemirror.png"

# Make files executable (on Linux/WSL)
if ($IsLinux) {
    chmod +x "$AppDir/AppRun"
    chmod +x "$AppDir/usr/bin/PhoneMirror"
}

# Create AppImage (requires appimagetool)
Write-Host "Creating AppImage..."
Write-Host "Note: Requires appimagetool from https://github.com/AppImage/AppImageKit/releases"
Write-Host ""

if ($IsLinux) {
    $AppImageTool = "appimagetool"
    if (Get-Command $AppImageTool -ErrorAction SilentlyContinue) {
        & $AppImageTool $AppDir "$OutputPath/PhoneMirror-x86_64.AppImage"
        if ($LASTEXITCODE -eq 0) {
            Write-Host ""
            Write-Host "AppImage created: $OutputPath/PhoneMirror-x86_64.AppImage"
        }
    } else {
        Write-Host "appimagetool not found. AppDir created at: $AppDir"
        Write-Host "Download appimagetool and run:"
        Write-Host "  appimagetool $AppDir $OutputPath/PhoneMirror-x86_64.AppImage"
    }
} else {
    Write-Host "AppImage creation requires Linux. AppDir structure created at:"
    Write-Host "  $AppDir"
    Write-Host ""
    Write-Host "To create AppImage on Linux:"
    Write-Host "  1. Transfer AppDir to Linux machine"
    Write-Host "  2. Download appimagetool"
    Write-Host "  3. Run: appimagetool PhoneMirror.AppDir PhoneMirror-x86_64.AppImage"
}

Write-Host ""
Write-Host "Linux build complete!"
```
  </action>
  <verify>PowerShell script syntax is valid</verify>
  <done>Linux publish script created with AppImage support</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Linux packaging infrastructure (desktop entry, AppRun, publish script)</what-built>
  <how-to-verify>
    1. Review PhoneMirror.desktop has correct categories and metadata
    2. Review AppRun script sets up environment correctly
    3. Review publish-linux.ps1 creates proper AppDir structure

    Note: Actual AppImage creation requires Linux environment and appimagetool.
    This checkpoint verifies the infrastructure is correctly defined.
  </how-to-verify>
  <resume-signal>Type "approved" if Linux packaging infrastructure looks correct, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] packaging/linux/PhoneMirror.desktop exists with correct format
- [ ] packaging/linux/AppRun exists with proper bash shebang
- [ ] scripts/publish-linux.ps1 exists with valid PowerShell syntax
- [ ] Script creates correct AppDir structure
</verification>

<success_criteria>
- Desktop entry follows freedesktop.org specification
- AppRun script properly launches .NET application
- Publish script handles AppDir creation
- Script can run on Windows (produces AppDir) or Linux (produces AppImage)
</success_criteria>

<output>
After completion, create `.planning/phases/06-packaging/06-03-SUMMARY.md`
</output>
