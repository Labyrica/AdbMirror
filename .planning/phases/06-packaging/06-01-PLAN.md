---
phase: 06-packaging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/PhoneMirror.Core/PhoneMirror.Core.csproj
  - src/PhoneMirror/PhoneMirror.csproj
  - scripts/prepare-resources.ps1
  - scripts/publish-windows.ps1
autonomous: true
user_setup:
  - service: platform-tools
    why: "ADB binaries for device communication"
    download:
      - url: "https://developer.android.com/studio/releases/platform-tools"
        instruction: "Download Windows platform-tools ZIP"
        destination: "src/PhoneMirror.Core/Resources/platform-tools/"
  - service: scrcpy
    why: "Screen mirroring binary"
    download:
      - url: "https://github.com/Genymobile/scrcpy/releases"
        instruction: "Download scrcpy-win64-vX.X.zip"
        destination: "src/PhoneMirror.Core/Resources/scrcpy/"
---

<objective>
Configure resource embedding and create Windows packaging infrastructure.

Purpose: Prepare the project for distribution by embedding platform-tools and scrcpy binaries, then create a Windows installer using Velopack for professional deployment with auto-update capability.
Output: Embedded resources in PhoneMirror.Core, Windows publish script, Velopack installer configuration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/PhoneMirror.Core/PhoneMirror.Core.csproj
@src/PhoneMirror/PhoneMirror.csproj
@src/PhoneMirror.Core/Services/ResourceExtractor.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure embedded resources in PhoneMirror.Core</name>
  <files>src/PhoneMirror.Core/PhoneMirror.Core.csproj</files>
  <action>
Update PhoneMirror.Core.csproj to embed platform-tools and scrcpy as resources:

1. Create Resources directory structure:
   - src/PhoneMirror.Core/Resources/ (will contain ZIP files)

2. Add ItemGroup for embedded resources (conditional on file existence):
```xml
<ItemGroup>
  <EmbeddedResource Include="Resources\platform-tools.zip" Condition="Exists('Resources\platform-tools.zip')">
    <LogicalName>PhoneMirror.Core.Resources.platform-tools.zip</LogicalName>
  </EmbeddedResource>
  <EmbeddedResource Include="Resources\scrcpy.zip" Condition="Exists('Resources\scrcpy.zip')">
    <LogicalName>PhoneMirror.Core.Resources.scrcpy.zip</LogicalName>
  </EmbeddedResource>
</ItemGroup>
```

3. Add .gitignore entry for Resources/*.zip files (binaries should not be committed):
```
# Binary resources (download separately)
src/PhoneMirror.Core/Resources/*.zip
```

The ResourceExtractor.cs already looks for `PhoneMirror.Core.Resources.{resourceName}` so this configuration matches.
  </action>
  <verify>dotnet build src/PhoneMirror.Core succeeds (resources optional at build time)</verify>
  <done>PhoneMirror.Core.csproj configured to embed resources when present</done>
</task>

<task type="auto">
  <name>Task 2: Create resource preparation PowerShell script</name>
  <files>scripts/prepare-resources.ps1</files>
  <action>
Create a cross-platform PowerShell script to prepare resources for embedding:

```powershell
# prepare-resources.ps1
# Downloads and prepares platform-tools and scrcpy for embedding

param(
    [string]$ResourcesPath = "$PSScriptRoot/../src/PhoneMirror.Core/Resources"
)

$ErrorActionPreference = "Stop"

# Ensure Resources directory exists
New-Item -ItemType Directory -Force -Path $ResourcesPath | Out-Null

Write-Host "Resource preparation script"
Write-Host "==========================="
Write-Host ""
Write-Host "This script prepares platform-tools and scrcpy for embedding."
Write-Host "You need to manually download the files first:"
Write-Host ""
Write-Host "1. platform-tools:"
Write-Host "   - Windows: https://dl.google.com/android/repository/platform-tools-latest-windows.zip"
Write-Host "   - macOS:   https://dl.google.com/android/repository/platform-tools-latest-darwin.zip"
Write-Host "   - Linux:   https://dl.google.com/android/repository/platform-tools-latest-linux.zip"
Write-Host ""
Write-Host "2. scrcpy:"
Write-Host "   - Visit: https://github.com/Genymobile/scrcpy/releases/latest"
Write-Host "   - Download appropriate version for your platform"
Write-Host ""

# Check for existing extracted folders and create ZIPs
$platformToolsDir = "$ResourcesPath/platform-tools"
$scrcpyDir = "$ResourcesPath/scrcpy"

if (Test-Path $platformToolsDir) {
    Write-Host "Creating platform-tools.zip from $platformToolsDir..."
    $zipPath = "$ResourcesPath/platform-tools.zip"
    if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
    Compress-Archive -Path "$platformToolsDir/*" -DestinationPath $zipPath
    Write-Host "Created: platform-tools.zip"
} else {
    Write-Host "WARNING: platform-tools folder not found at $platformToolsDir"
    Write-Host "         Extract platform-tools there before running this script."
}

if (Test-Path $scrcpyDir) {
    Write-Host "Creating scrcpy.zip from $scrcpyDir..."
    $zipPath = "$ResourcesPath/scrcpy.zip"
    if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
    Compress-Archive -Path "$scrcpyDir/*" -DestinationPath $zipPath
    Write-Host "Created: scrcpy.zip"
} else {
    Write-Host "WARNING: scrcpy folder not found at $scrcpyDir"
    Write-Host "         Extract scrcpy there before running this script."
}

Write-Host ""
Write-Host "Done. Run 'dotnet build' to embed resources."
```

Create scripts/ directory if it doesn't exist.
  </action>
  <verify>PowerShell script syntax is valid: pwsh -Command "& { . scripts/prepare-resources.ps1 -WhatIf }" (or check syntax only)</verify>
  <done>prepare-resources.ps1 created with instructions and ZIP creation logic</done>
</task>

<task type="auto">
  <name>Task 3: Create Windows publish script with Velopack</name>
  <files>scripts/publish-windows.ps1, src/PhoneMirror/PhoneMirror.csproj</files>
  <action>
Create Windows publish script and update csproj for self-contained deployment:

**1. Update PhoneMirror.csproj with publish properties:**

Add PropertyGroup for publishing:
```xml
<PropertyGroup>
  <Version>1.0.0</Version>
  <Authors>Labyrica</Authors>
  <Product>Phone Mirror</Product>
  <Description>One-click Android screen mirroring</Description>
  <PublishSingleFile>true</PublishSingleFile>
  <SelfContained>true</SelfContained>
  <IncludeNativeLibrariesForSelfExtract>true</IncludeNativeLibrariesForSelfExtract>
  <EnableCompressionInSingleFile>true</EnableCompressionInSingleFile>
</PropertyGroup>
```

**2. Create scripts/publish-windows.ps1:**

```powershell
# publish-windows.ps1
# Builds and publishes Phone Mirror for Windows

param(
    [string]$Configuration = "Release",
    [string]$Runtime = "win-x64",
    [string]$OutputPath = "$PSScriptRoot/../publish/windows"
)

$ErrorActionPreference = "Stop"
$ProjectPath = "$PSScriptRoot/../src/PhoneMirror/PhoneMirror.csproj"

Write-Host "Publishing Phone Mirror for Windows..."
Write-Host "Configuration: $Configuration"
Write-Host "Runtime: $Runtime"
Write-Host ""

# Clean output directory
if (Test-Path $OutputPath) {
    Remove-Item -Recurse -Force $OutputPath
}
New-Item -ItemType Directory -Force -Path $OutputPath | Out-Null

# Publish
dotnet publish $ProjectPath `
    -c $Configuration `
    -r $Runtime `
    --self-contained true `
    -o $OutputPath

if ($LASTEXITCODE -ne 0) {
    Write-Error "Publish failed!"
    exit 1
}

Write-Host ""
Write-Host "Publish complete!"
Write-Host "Output: $OutputPath"
Write-Host ""

# List output files
Get-ChildItem $OutputPath | Format-Table Name, Length
```

**Note:** Velopack integration is deferred to a future enhancement. The current script produces a portable single-file executable which is sufficient for initial distribution. Velopack can be added later for auto-update support.
  </action>
  <verify>dotnet publish src/PhoneMirror/PhoneMirror.csproj -c Release -r win-x64 --self-contained true succeeds</verify>
  <done>Windows publish script created, PhoneMirror.csproj configured for self-contained deployment</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build src/PhoneMirror.Core` succeeds
- [ ] `dotnet build src/PhoneMirror` succeeds
- [ ] scripts/prepare-resources.ps1 exists and has valid PowerShell syntax
- [ ] scripts/publish-windows.ps1 exists and has valid PowerShell syntax
- [ ] PhoneMirror.csproj has Version, PublishSingleFile, SelfContained properties
- [ ] PhoneMirror.Core.csproj has EmbeddedResource configuration for ZIP files
</verification>

<success_criteria>
- Project configured for embedded resources
- Resource preparation script created with clear instructions
- Windows publish script produces working single-file executable
- Build succeeds without embedded resources (graceful fallback)
</success_criteria>

<output>
After completion, create `.planning/phases/06-packaging/06-01-SUMMARY.md`
</output>
