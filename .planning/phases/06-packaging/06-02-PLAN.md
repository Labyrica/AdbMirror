---
phase: 06-packaging
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - scripts/publish-macos.ps1
  - src/PhoneMirror/Info.plist
autonomous: false
user_setup:
  - service: apple-developer
    why: "Code signing and notarization for macOS distribution"
    account_setup:
      - url: "https://developer.apple.com/programs/"
        skip_if: "Already enrolled in Apple Developer Program ($99/year)"
    dashboard_config:
      - task: "Create Developer ID Application certificate"
        location: "Certificates, Identifiers & Profiles"
        details: "Required for signing apps distributed outside App Store"
      - task: "Create app-specific password for notarytool"
        location: "appleid.apple.com → Security → App-Specific Passwords"
        details: "Used for notarization submission"
  - service: platform-tools-macos
    why: "macOS-specific ADB binaries"
    download:
      - url: "https://dl.google.com/android/repository/platform-tools-latest-darwin.zip"
        destination: "src/PhoneMirror.Core/Resources/platform-tools/"
  - service: scrcpy-macos
    why: "macOS-specific scrcpy binary"
    download:
      - url: "https://github.com/Genymobile/scrcpy/releases"
        instruction: "Download scrcpy-macos-vX.X.tar.gz or build from source"
        destination: "src/PhoneMirror.Core/Resources/scrcpy/"
---

<objective>
Create macOS app bundle with code signing and notarization.

Purpose: Package Phone Mirror as a proper macOS .app bundle that passes Gatekeeper verification and can be distributed outside the Mac App Store.
Output: publish-macos.ps1 script, Info.plist template, signed and notarized .app bundle.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-packaging/06-01-SUMMARY.md

@src/PhoneMirror/PhoneMirror.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Info.plist for macOS app bundle</name>
  <files>src/PhoneMirror/Info.plist</files>
  <action>
Create Info.plist file for macOS app bundle metadata:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleName</key>
    <string>Phone Mirror</string>
    <key>CFBundleDisplayName</key>
    <string>Phone Mirror</string>
    <key>CFBundleIdentifier</key>
    <string>com.labyrica.phonemirror</string>
    <key>CFBundleVersion</key>
    <string>1.0.0</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0.0</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleExecutable</key>
    <string>PhoneMirror</string>
    <key>CFBundleIconFile</key>
    <string>AppIcon</string>
    <key>LSMinimumSystemVersion</key>
    <string>10.15</string>
    <key>NSHighResolutionCapable</key>
    <true/>
    <key>NSHumanReadableCopyright</key>
    <string>Copyright 2024-2026 Labyrica. All rights reserved.</string>
    <key>LSApplicationCategoryType</key>
    <string>public.app-category.developer-tools</string>
    <key>NSBluetoothAlwaysUsageDescription</key>
    <string>Phone Mirror may use Bluetooth for device discovery.</string>
</dict>
</plist>
```

This plist will be copied into the .app bundle during packaging.
  </action>
  <verify>File exists at src/PhoneMirror/Info.plist and is valid XML</verify>
  <done>Info.plist created with app metadata</done>
</task>

<task type="auto">
  <name>Task 2: Create macOS publish and bundle script</name>
  <files>scripts/publish-macos.ps1</files>
  <action>
Create PowerShell script for macOS app bundle creation:

```powershell
# publish-macos.ps1
# Builds Phone Mirror for macOS and creates .app bundle
# Must be run on macOS

param(
    [string]$Configuration = "Release",
    [string]$Runtime = "osx-x64",  # or osx-arm64 for Apple Silicon
    [string]$OutputPath = "$PSScriptRoot/../publish/macos",
    [string]$SigningIdentity = "",  # "Developer ID Application: Your Name (TEAMID)"
    [string]$AppleId = "",          # For notarization
    [string]$TeamId = "",           # For notarization
    [switch]$SkipNotarization
)

$ErrorActionPreference = "Stop"
$ProjectPath = "$PSScriptRoot/../src/PhoneMirror/PhoneMirror.csproj"
$InfoPlistPath = "$PSScriptRoot/../src/PhoneMirror/Info.plist"
$AppName = "Phone Mirror"
$BundlePath = "$OutputPath/$AppName.app"

Write-Host "Publishing Phone Mirror for macOS..."
Write-Host "Configuration: $Configuration"
Write-Host "Runtime: $Runtime"
Write-Host ""

# Verify running on macOS
if ($IsMacOS -ne $true) {
    Write-Error "This script must be run on macOS"
    exit 1
}

# Clean output directory
if (Test-Path $OutputPath) {
    Remove-Item -Recurse -Force $OutputPath
}

# Publish .NET app
Write-Host "Building application..."
dotnet publish $ProjectPath `
    -c $Configuration `
    -r $Runtime `
    --self-contained true `
    -o "$OutputPath/bin"

if ($LASTEXITCODE -ne 0) {
    Write-Error "Publish failed!"
    exit 1
}

# Create .app bundle structure
Write-Host "Creating app bundle..."
New-Item -ItemType Directory -Force -Path "$BundlePath/Contents/MacOS" | Out-Null
New-Item -ItemType Directory -Force -Path "$BundlePath/Contents/Resources" | Out-Null

# Copy files
Copy-Item "$OutputPath/bin/*" "$BundlePath/Contents/MacOS/" -Recurse
Copy-Item $InfoPlistPath "$BundlePath/Contents/Info.plist"

# Set executable permission
chmod +x "$BundlePath/Contents/MacOS/PhoneMirror"

# Code signing (if identity provided)
if ($SigningIdentity) {
    Write-Host "Signing app bundle..."
    codesign --force --deep --sign "$SigningIdentity" `
        --options runtime `
        --entitlements "$PSScriptRoot/entitlements.plist" `
        "$BundlePath"

    if ($LASTEXITCODE -ne 0) {
        Write-Error "Code signing failed!"
        exit 1
    }

    # Verify signature
    codesign --verify --deep --strict "$BundlePath"
}

# Notarization (if credentials provided and not skipped)
if ($SigningIdentity -and $AppleId -and $TeamId -and -not $SkipNotarization) {
    Write-Host "Creating ZIP for notarization..."
    $ZipPath = "$OutputPath/PhoneMirror.zip"
    ditto -c -k --keepParent "$BundlePath" $ZipPath

    Write-Host "Submitting for notarization..."
    xcrun notarytool submit $ZipPath `
        --apple-id $AppleId `
        --team-id $TeamId `
        --wait

    if ($LASTEXITCODE -eq 0) {
        Write-Host "Stapling notarization ticket..."
        xcrun stapler staple "$BundlePath"
    }
}

Write-Host ""
Write-Host "macOS build complete!"
Write-Host "App bundle: $BundlePath"
```

Note: This script requires:
1. Running on macOS
2. Xcode command line tools installed
3. Apple Developer certificate for signing
4. Apple ID and team ID for notarization
  </action>
  <verify>PowerShell script syntax is valid (check on any platform)</verify>
  <done>macOS publish script created with signing and notarization support</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>macOS packaging infrastructure (Info.plist and publish script)</what-built>
  <how-to-verify>
    1. Review Info.plist has correct bundle identifier and metadata
    2. Review publish-macos.ps1 script logic
    3. Confirm user_setup requirements are understood (Apple Developer Program, certificates)

    Note: Actual build and signing requires macOS environment and Apple Developer enrollment.
    This checkpoint verifies the infrastructure is correctly defined.
  </how-to-verify>
  <resume-signal>Type "approved" if macOS packaging infrastructure looks correct, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/PhoneMirror/Info.plist exists with correct bundle metadata
- [ ] scripts/publish-macos.ps1 exists with valid PowerShell syntax
- [ ] Script handles both osx-x64 (Intel) and osx-arm64 (Apple Silicon)
- [ ] Code signing and notarization steps documented
</verification>

<success_criteria>
- Info.plist created with proper macOS app bundle metadata
- Publish script handles .app bundle creation
- Script supports optional code signing and notarization
- User setup requirements clearly documented
</success_criteria>

<output>
After completion, create `.planning/phases/06-packaging/06-02-SUMMARY.md`
</output>
