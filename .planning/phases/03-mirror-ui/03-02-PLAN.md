# Plan 03-02: Device List and Connection Status UI

**Phase**: 03-mirror-ui
**Depends on**: 03-01 (layout), Phase 2 services (IAdbService)
**Requirements**: CONN-03 (device state display), CONN-04 (friendly device name)

## Objective

Wire up MainWindowViewModel to IAdbService for device polling and display connection status in the UI. Show device state (connected/disconnected/unauthorized/error) with appropriate messaging. Display friendly device name (model) instead of serial number.

## Reference

WPF MainViewModel pattern:
- Polls IAdbService via StartPollingAsync
- Updates StatusText based on DeviceState enum
- Shows device model in status when connected
- Uses Dispatcher.Invoke for UI thread marshalling (Avalonia uses Dispatcher.UIThread.Post)

## Tasks

### Task 1: Add device state properties to MainWindowViewModel

Add observable properties for device status display.

**File**: `src/PhoneMirror/ViewModels/MainWindowViewModel.cs`

**Changes**:
1. Add using statements for PhoneMirror.Core.Services, PhoneMirror.Core.Models, CommunityToolkit.Mvvm.ComponentModel
2. Add `[ObservableProperty]` fields:
   - `_statusText` (string) - default "Initializing..."
   - `_adbPathText` (string) - default ""
   - `_currentDevice` (AndroidDevice?) - private tracking
   - `_currentState` (DeviceState) - private tracking
3. Add computed property `DeviceDisplayName` that returns currentDevice?.DisplayName ?? "No device"

**Verification**: Build succeeds

### Task 2: Inject IAdbService and start device polling

Wire up service injection and begin device polling on startup.

**File**: `src/PhoneMirror/ViewModels/MainWindowViewModel.cs`

**Changes**:
1. Add constructor parameter `IAdbService adbService`
2. Store as readonly field `_adbService`
3. Add `CancellationTokenSource _pollCts` for polling lifecycle
4. Create `InitializeAsync()` method that:
   - Checks `_adbService.IsAvailableAsync()`, sets error StatusText if unavailable
   - Sets `AdbPathText` from `_adbService.AdbPath`
   - Calls `_adbService.StartPollingAsync(TimeSpan.FromSeconds(1), OnDeviceStateChanged, _pollCts.Token)`
5. Call InitializeAsync() from constructor (fire-and-forget with `_ = InitializeAsync()`)
6. Implement `IDisposable` to cancel polling on dispose

**File**: `src/PhoneMirror/App.axaml.cs`

**Changes**:
1. MainWindowViewModel registration already has IAdbService available via DI - no changes needed (DI resolves automatically)

**Verification**: Build succeeds, app starts without exceptions

### Task 3: Implement device state change handler

Handle state changes and update UI properties on UI thread.

**File**: `src/PhoneMirror/ViewModels/MainWindowViewModel.cs`

**Changes**:
1. Add `OnDeviceStateChanged(DeviceState state, AndroidDevice? device)` callback method
2. Store state and device in private fields
3. Use `Avalonia.Threading.Dispatcher.UIThread.Post()` to update observable properties
4. Map DeviceState to user-friendly StatusText messages:
   - NoDevice → "No device connected"
   - Unauthorized → "Device unauthorized: check phone prompt"
   - Offline → "Device offline"
   - Connected → "Device connected: {device.DisplayName}"
   - MultipleDevices → "Multiple devices connected"
   - AdbNotAvailable → "ADB not available"
   - Mirroring → "Mirroring active" (handled in 03-03)

**Verification**: Build succeeds, connect Android device and verify status updates

### Task 4: Bind status properties to MainWindow XAML

Connect ViewModel properties to UI elements.

**File**: `src/PhoneMirror/Views/MainWindow.axaml`

**Changes**:
1. Update status TextBlock to bind `Text="{Binding StatusText}"`
2. Update ADB path TextBlock to bind `Text="{Binding AdbPathText}"`
3. Update device summary section to show connection indicator based on state

**Verification**: Build and run, verify status text updates when device connects/disconnects

## Completion Criteria

- [ ] StatusText updates when device connects/disconnects
- [ ] AdbPathText shows resolved ADB path
- [ ] Unauthorized device shows "check phone prompt" message
- [ ] Connected device shows friendly model name (not serial)
- [ ] Multiple devices scenario handled gracefully
- [ ] No UI thread exceptions during state updates

## Wave

Wave 2 (requires 03-01 layout)

---
*Plan: 03-02*
*Phase: 03-mirror-ui*
