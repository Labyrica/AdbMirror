# Plan 03-04: Settings Persistence and Options Panel

**Phase**: 03-mirror-ui
**Depends on**: 03-01 (layout), 03-03 (quality selector for preset persistence)
**Requirements**: UX-02 (settings persistence), MIRR-03 (keep screen awake), MIRR-04 (auto-mirror), MIRR-05 (fullscreen), MIRR-06 (always-on-top), MIRR-07 (resize)

## Objective

Create settings service for persisting user preferences between sessions. Add checkbox options for auto-mirror, fullscreen, and keep screen awake. Settings persist to JSON file in local app data. Window resize is already supported by Avalonia defaults.

## Reference

WPF AppSettings.cs pattern:
- JSON file in LocalApplicationData/PhoneMirror/settings.json
- Properties: DefaultPreset, AutoMirrorOnConnect, StartFullscreen, KeepScreenAwake
- Static Load() returns deserialized or default instance
- Save() writes current state to disk
- Settings bound to ViewModel checkboxes with immediate save on change

## Tasks

### Task 1: Create ISettingsService interface and implementation

Create cross-platform settings persistence service.

**File**: `src/PhoneMirror.Core/Services/ISettingsService.cs` (new)

**Changes**:
1. Create interface with properties:
   - `ScrcpyPreset DefaultPreset { get; set; }`
   - `bool AutoMirrorOnConnect { get; set; }`
   - `bool StartFullscreen { get; set; }`
   - `bool KeepScreenAwake { get; set; }`
2. Add methods:
   - `void Save()`
   - `Task LoadAsync()` (for initial load)

**File**: `src/PhoneMirror.Core/Services/SettingsService.cs` (new)

**Changes**:
1. Implement ISettingsService with JSON persistence
2. Path: `{LocalApplicationData}/PhoneMirror/settings.json`
3. Use System.Text.Json for serialization
4. Handle missing file (return defaults) and corrupted file (log and return defaults)
5. Properties trigger Save() on set for immediate persistence

**Verification**: Build succeeds

### Task 2: Register SettingsService and inject into ViewModel

Wire up settings in DI container.

**File**: `src/PhoneMirror/App.axaml.cs`

**Changes**:
1. Add `services.AddSingleton<ISettingsService, SettingsService>()`
2. Load settings early in startup: get service and call LoadAsync()

**File**: `src/PhoneMirror/ViewModels/MainWindowViewModel.cs`

**Changes**:
1. Add constructor parameter `ISettingsService settingsService`
2. Store as readonly field `_settings`
3. Initialize `SelectedPreset` from `_settings.DefaultPreset`
4. Update SelectedPreset setter to persist: `_settings.DefaultPreset = value; _settings.Save();`

**Verification**: Build succeeds, preset persists across app restarts

### Task 3: Add settings checkbox properties to ViewModel

Expose settings as bindable properties.

**File**: `src/PhoneMirror/ViewModels/MainWindowViewModel.cs`

**Changes**:
1. Add property `AutoMirrorOnConnect` that gets/sets from `_settings` and calls `_settings.Save()`
2. Add property `StartFullscreen` that gets/sets from `_settings` and calls `_settings.Save()`
3. Add property `KeepScreenAwake` that gets/sets from `_settings` and calls `_settings.Save()`
4. Implement `OnPropertyChanged` for these properties to notify UI

**Verification**: Build succeeds

### Task 4: Implement auto-mirror on device connect

Trigger mirroring automatically when device connects (if enabled).

**File**: `src/PhoneMirror/ViewModels/MainWindowViewModel.cs`

**Changes**:
1. Add `_lastAutoMirroredSerial` field to track device
2. In `OnDeviceStateChanged`, when state is Connected and AutoMirrorOnConnect is true:
   - Check serial hasn't already been auto-mirrored (prevent repeated triggers)
   - Call MirrorAsync() automatically
   - Set `_lastAutoMirroredSerial = device.Serial`
3. Reset `_lastAutoMirroredSerial` on NoDevice or Offline states

**Verification**: Enable auto-mirror, connect device, verify mirroring starts automatically

### Task 5: Build settings options panel in XAML

Create checkbox controls for settings.

**File**: `src/PhoneMirror/Views/MainWindow.axaml`

**Changes**:
1. In settings area, add "SETTINGS" label
2. Add CheckBox: Content="Auto mirror when device connects" IsChecked="{Binding AutoMirrorOnConnect}"
3. Add CheckBox: Content="Start scrcpy in fullscreen" IsChecked="{Binding StartFullscreen}"
4. Add CheckBox: Content="Keep screen awake" IsChecked="{Binding KeepScreenAwake}"
5. Apply consistent styling with FluentAvalonia theme

**Verification**: Build and run, toggle checkboxes, restart app and verify settings persist

### Task 6: Pass settings to scrcpy service

Use persisted settings when starting mirroring.

**File**: `src/PhoneMirror/ViewModels/MainWindowViewModel.cs`

**Changes**:
1. Update `MirrorAsync()` to pass settings to StartMirroringAsync:
   - Pass `_settings.KeepScreenAwake` for screen awake option
   - For fullscreen: check if IScrcpyService supports it, or add argument handling

**File**: `src/PhoneMirror.Core/Services/ScrcpyService.cs`

**Changes**:
1. Update `StartMirroringAsync` signature to accept `bool fullscreen` parameter
2. Add `-f` or `--fullscreen` argument when fullscreen is true
3. Note: always-on-top (`--always-on-top`) can be added later in Phase 4 or as enhancement

**Verification**: Enable fullscreen, start mirror, verify scrcpy opens in fullscreen mode

## Completion Criteria

- [ ] Settings persist to JSON in LocalApplicationData
- [ ] Quality preset persists across app restarts
- [ ] Auto-mirror checkbox works and triggers on device connect
- [ ] Fullscreen checkbox works and passes to scrcpy
- [ ] Keep screen awake checkbox works and passes to scrcpy
- [ ] Settings UI matches WPF reference layout
- [ ] Window remains freely resizable (MIRR-07 - default Avalonia behavior)

## Notes on MIRR-06 (always-on-top)

Always-on-top for the scrcpy window is controlled via scrcpy's `--always-on-top` flag. This can be added as a checkbox in a future iteration or bundled with this plan if time permits. The core requirement is to pass the flag to scrcpy - no Avalonia window manipulation needed since scrcpy manages its own window.

## Wave

Wave 3 (requires 03-03 for mirroring integration)

---
*Plan: 03-04*
*Phase: 03-mirror-ui*
