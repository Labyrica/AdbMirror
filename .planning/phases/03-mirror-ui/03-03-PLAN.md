# Plan 03-03: Mirroring Controls and Quality Selector

**Phase**: 03-mirror-ui
**Depends on**: 03-01 (layout), 03-02 (device state), Phase 2 services (IScrcpyService)
**Requirements**: MIRR-01 (start/stop), MIRR-02 (quality preset), MIRR-05 (fullscreen toggle via scrcpy args)

## Objective

Implement the Mirror button with start/stop functionality, quality preset selector (Low/Balanced/High), and wire up to IScrcpyService. The Mirror button is the hero element - prominent at 56px height. Button text changes between "Mirror" and "Stop" based on mirroring state.

## Reference

WPF patterns:
- `PrimaryCommand` bound to ICommand, toggles between start/stop based on `_isMirroring`
- `IsPrimaryEnabled` property controls button state
- `PrimaryButtonText` switches between "Mirror" and "Stop"
- `SelectedPreset` bound to ComboBox, persists to settings
- ScrcpyService.StartMirroring() takes serial, preset, keepScreenAwake

## Tasks

### Task 1: Add mirroring state properties to MainWindowViewModel

Add observable properties for mirroring control.

**File**: `src/PhoneMirror/ViewModels/MainWindowViewModel.cs`

**Changes**:
1. Add `[ObservableProperty]` fields:
   - `_primaryButtonText` (string) - default "Mirror"
   - `_isPrimaryEnabled` (bool) - default false
   - `_isMirroring` (bool) - private tracking
2. Add `ObservableCollection<ScrcpyPreset> Presets` property initialized with [Low, Balanced, High]
3. Add `[ObservableProperty]` `_selectedPreset` (ScrcpyPreset) - default Balanced

**Verification**: Build succeeds

### Task 2: Inject IScrcpyService and implement mirror command

Wire up scrcpy service and create command for mirror button.

**File**: `src/PhoneMirror/ViewModels/MainWindowViewModel.cs`

**Changes**:
1. Add constructor parameter `IScrcpyService scrcpyService`
2. Store as readonly field `_scrcpyService`
3. Subscribe to `_scrcpyService.MirroringStopped` event in constructor
4. Add `[RelayCommand(CanExecute = nameof(CanMirror))]` async method `MirrorAsync()`:
   - If `_isMirroring`: call `_scrcpyService.StopMirroring()`, set `_isMirroring = false`
   - Else: call `await _scrcpyService.StartMirroringAsync(...)`, handle result
   - Update `PrimaryButtonText` and `IsPrimaryEnabled` accordingly
5. Add `bool CanMirror()` that returns `IsPrimaryEnabled`
6. Update `OnDeviceStateChanged` to set `IsPrimaryEnabled = true` when Connected or MultipleDevices

**Verification**: Build succeeds

### Task 3: Handle mirroring stopped event

Respond to scrcpy process exit.

**File**: `src/PhoneMirror/ViewModels/MainWindowViewModel.cs`

**Changes**:
1. Add `OnMirroringStopped(object? sender, string message)` handler
2. Use `Dispatcher.UIThread.Post()` to:
   - Set `_isMirroring = false`
   - Set `PrimaryButtonText = "Mirror"`
   - Update `StatusText` with exit message
   - Re-evaluate device state via `OnDeviceStateChanged`

**Verification**: Build succeeds, mirroring session ends cleanly

### Task 4: Build mirror button and quality selector in XAML

Create the hero Mirror button and quality ComboBox.

**File**: `src/PhoneMirror/Views/MainWindow.axaml`

**Changes**:
1. Replace placeholder button with styled Mirror button:
   - Height="56", full width
   - Command="{Binding MirrorCommand}"
   - Content shows icon (play/stop) + `{Binding PrimaryButtonText}`
   - IsEnabled="{Binding IsPrimaryEnabled}"
   - Use AccentButtonStyle or similar prominent FluentAvalonia style
2. Add quality preset section:
   - Label "QUALITY PRESET"
   - ComboBox ItemsSource="{Binding Presets}" SelectedItem="{Binding SelectedPreset}"
   - Width="160"

**Verification**: Build and run, verify button enables when device connected, clicking starts/stops mirroring

## Completion Criteria

- [ ] Mirror button is hero element (prominent, 56px height)
- [ ] Button text changes between "Mirror" and "Stop"
- [ ] Button disabled when no device connected
- [ ] Quality selector shows Low/Balanced/High options
- [ ] Selecting quality changes scrcpy arguments
- [ ] Clicking Mirror starts scrcpy process
- [ ] Clicking Stop terminates scrcpy process
- [ ] Process exit updates UI state correctly

## Wave

Wave 2 (can run in parallel with 03-02 after 03-01 completes)

---
*Plan: 03-03*
*Phase: 03-mirror-ui*
